#!/usr/bin/env bpftrace
/*
 * 01_test_node_tracing.bt
 *
 * Test real-time plan node execution tracing.
 * This verifies we can capture InstrStartNode/InstrStopNode events.
 *
 * Usage:
 *   sudo bpftrace 01_test_node_tracing.bt -p <backend_pid>
 *
 * Or to trace all postgres backends:
 *   sudo bpftrace 01_test_node_tracing.bt
 *
 * Prerequisites:
 *   - PostgreSQL with debug symbols
 *   - A query running with instrumentation (e.g., via auto_explain with log_analyze=on)
 *
 * What this tests:
 *   - Can we hook InstrStartNode/InstrStopNode?
 *   - Can we read Instrumentation struct fields?
 *   - Timing of node execution
 */

/* Instrumentation struct offsets for PG13 (verify with your build) */
/* These may vary - use: gdb -batch -ex 'p &((struct Instrumentation*)0)->FIELD' postgres */

BEGIN
{
    printf("=== PostgreSQL Plan Node Tracer ===\n");
    printf("Tracing InstrStartNode/InstrStopNode...\n");
    printf("Run a query with instrumentation enabled.\n\n");
}

/* Track node start - InstrStartNode(Instrumentation *instr) */
uprobe:/usr/lib/postgresql/13/bin/postgres:InstrStartNode
{
    @node_start[tid] = nsecs;
    @node_depth[tid] = @node_depth[tid] + 1;

    printf("[%d] NODE_START depth=%d tim=%lu\n",
           tid, @node_depth[tid], nsecs / 1000);
}

/* Track node stop - InstrStopNode(Instrumentation *instr, double nTuples) */
uprobe:/usr/lib/postgresql/13/bin/postgres:InstrStopNode
{
    $instr = (uint64)arg0;
    $elapsed_us = (nsecs - @node_start[tid]) / 1000;

    /* Read Instrumentation fields */
    /* Offset 0xD0 = ntuples (double), 0x30 = tuplecount (double) */
    /* These offsets are for PG13 ARM64 - adjust for your platform */

    printf("[%d] NODE_STOP  depth=%d ela=%lu us\n",
           tid, @node_depth[tid], $elapsed_us);

    @node_depth[tid] = @node_depth[tid] - 1;
    delete(@node_start[tid]);
}

/* Also trace ExecProcNodeFirst to see first node execution */
uprobe:/usr/lib/postgresql/13/bin/postgres:ExecProcNodeFirst*
{
    printf("[%d] FIRST_EXEC planstate=%p\n", tid, arg0);
}

END
{
    printf("\n=== Trace Complete ===\n");
    clear(@node_start);
    clear(@node_depth);
}
